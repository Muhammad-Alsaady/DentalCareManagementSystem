@model List<DentalCareManagmentSystem.Application.DTOs.AppointmentDto>

@{
    ViewData["Title"] = "Today's Appointments";
    var selectedDate = ViewBag.SelectedDate ?? DateTime.Today;
}

<div class="page-title">
    <div class="d-flex justify-content-between align-items-center">
        <h3>
            <i class="fas fa-calendar-check"></i> Today's Appointments & Queue Management
        </h3>
        <div>
            <button onclick="showQueue()" class="btn btn-primary">
                <i class="fas fa-list"></i> View Queue
            </button>
            <button onclick="refreshGrid()" class="btn btn-secondary">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer"></div>

<!-- Date Filter and Action Buttons -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label for="appointmentDate" class="form-label fw-bold">
                    <i class="fas fa-calendar"></i> Select Date:
                </label>
                <input type="date" 
                       id="appointmentDate" 
                       class="form-control" 
                       value="@selectedDate.ToString("yyyy-MM-dd")" 
                       onchange="filterByDate(this.value)">
            </div>
            <div class="col-md-8 text-end">
                <button onclick="showAddPatientModal()" class="btn btn-primary me-2">
                    <i class="fas fa-user-plus"></i> Add Patient
                </button>
                <button onclick="showAddAppointmentModal()" class="btn btn-success">
                    <i class="fas fa-calendar-plus"></i> Add Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Queue Panel -->
<div class="card mb-3" id="queuePanel" style="display: none;">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
            <i class="fas fa-users"></i> Patients in Queue (Sent to Doctor)
            <button type="button" class="btn-close float-end" onclick="$('#queuePanel').slideUp();"></button>
        </h5>
    </div>
    <div class="card-body">
        <div id="queueList">
            <!-- Queue items will be loaded here -->
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="table-main-title">
            <i class="fas fa-list"></i> Appointments for @selectedDate.ToString("MMMM dd, yyyy")
        </h5>
        
        <div id="gridContainer">
            @await Html.PartialAsync("_NotificationsGrid", Model)
        </div>
    </div>
</div>

<!-- Modal for Details -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailsModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Actions -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalLabel">Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="actionModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Column Width Distribution */
        .mvc-grid table {
            table-layout: fixed;
            width: 100%;
        }

        .col-patient-name { width: 18%; }
        .col-phone { width: 12%; }
        .col-date { width: 10%; }
        .col-start-time { width: 8%; }
        .col-end-time { width: 8%; }
        .col-status { width: 10%; }
        .col-paid-amount { width: 8%; }
        .col-remainder { width: 8%; }
        .col-notes { width: 10%; }
        .col-actions { width: 10%; }

        /* Text Overflow Handling */
        .mvc-grid table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mvc-grid table td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Enhanced Table Styling */
        .mvc-grid table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .mvc-grid table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding: 12px 8px;
        }

        .mvc-grid table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Queue Item Styling */
        .queue-item {
            border-left: 4px solid #ffc107;
            transition: all 0.3s ease;
        }

        .queue-item:hover {
            background-color: #fff3cd;
            transform: translateX(5px);
        }

        /* Date Input Styling */
        #appointmentDate {
            max-width: 300px;
        }

        /* Paid Amount Input Styling */
        .paid-amount-input {
            font-size: 0.875rem;
        }

        .paid-amount-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Remainder Display Styling */
        .text-danger {
            color: #dc3545 !important;
        }

        .text-success {
            color: #28a745 !important;
        }
    </style>
}

@section Scripts {
    <script>
        // Update Paid Amount
        function updatePaidAmount(appointmentId, paidAmount) {
            if (!paidAmount || paidAmount < 0) {
                showAlert('Invalid paid amount', 'error');
                return;
            }

            $.ajax({
                url: '@Url.Action("UpdatePaidAmount")',
                type: 'POST',
                data: {
                    appointmentId: appointmentId,
                    paidAmount: parseFloat(paidAmount),
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        // Update the remainder display
                        $('#remainder-' + appointmentId).text('$' + response.remainder.toFixed(2));
                        
                        // Update color based on remainder
                        var remainderElement = $('#remainder-' + appointmentId);
                        remainderElement.removeClass('text-danger text-success fw-bold');
                        if (response.remainder > 0) {
                            remainderElement.addClass('text-danger fw-bold');
                        } else {
                            remainderElement.addClass('text-success');
                        }
                    } else {
                        showAlert(response.message, 'error');
                    }
                },
                error: function(xhr) {
                    console.error('Error updating paid amount:', xhr);
                    showAlert('Failed to update paid amount', 'error');
                }
            });
        }

        // Filter appointments by date
        function filterByDate(date) {
            if (!date) {
                date = '@DateTime.Today.ToString("yyyy-MM-dd")';
            }
            
            $.ajax({
                url: '@Url.Action("GetNotificationsGrid")',
                type: 'GET',
                data: { selectedDate: date },
                success: function(result) {
                    $('#gridContainer').html(result);
                    // Reinitialize MVC Grid
                    document.querySelectorAll(".mvc-grid").forEach(el => new MvcGrid(el));
                    
                    // Update the page title
                    var dateObj = new Date(date);
                    var formattedDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    $('.table-main-title').html(`<i class="fas fa-list"></i> Appointments for ${formattedDate}`);
                },
                error: function(xhr) {
                    console.error('Error filtering appointments:', xhr);
                    showAlert('Failed to filter appointments', 'error');
                }
            });
        }

        // Show Add Patient Modal
        function showAddPatientModal() {
            $.ajax({
                url: '@Url.Action("Create", "Patients")',
                type: 'GET',
                success: function(result) {
                    $('#actionModalLabel').text('Add New Patient');
                    $('#actionModalBody').html(result);
                    var modal = new bootstrap.Modal(document.getElementById('actionModal'));
                    modal.show();
                },
                error: function(xhr) {
                    console.error('Error loading patient form:', xhr);
                    showAlert('Failed to load patient form', 'error');
                }
            });
        }

        // Show Add Appointment Modal
        function showAddAppointmentModal() {
            var selectedDate = $('#appointmentDate').val();
            $.ajax({
                url: '@Url.Action("Create", "Appointments")',
                type: 'GET',
                success: function(result) {
                    $('#actionModalLabel').text('Add New Appointment');
                    $('#actionModalBody').html(result);
                    
                    // Set the selected date in the appointment form
                    if (selectedDate) {
                        $('#actionModalBody input[name="Date"]').val(selectedDate);
                    }
                    
                    var modal = new bootstrap.Modal(document.getElementById('actionModal'));
                    modal.show();
                },
                error: function(xhr) {
                    console.error('Error loading appointment form:', xhr);
                    showAlert('Failed to load appointment form', 'error');
                }
            });
        }

        // Show Queue
        function showQueue() {
            $('#queuePanel').slideDown();
            loadQueue();
        }

        // Complete Appointment
        function completeAppointment(appointmentId, patientName) {
            if (confirm(`Mark appointment for ${patientName} as completed?`)) {
                $.ajax({
                    url: '@Url.Action("CompleteAppointment")',
                    type: 'POST',
                    data: {
                        appointmentId: appointmentId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showAlert(response.message, 'success');
                            refreshGrid();
                            loadQueue();
                        } else {
                            showAlert(response.message, 'error');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error completing appointment:', xhr);
                        showAlert('Failed to complete appointment', 'error');
                    }
                });
            }
        }

        // Load Queue
        function loadQueue() {
            $.ajax({
                url: '@Url.Action("Queue")',
                type: 'GET',
                success: function(result) {
                    var appointments = result;
                    if (appointments && appointments.length > 0) {
                        var html = '';
                        appointments.forEach(function(apt) {
                            html += `
                                <div class="queue-item p-3 mb-2 border rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-user"></i> ${apt.patientName}</strong><br>
                                            <small class="text-muted"><i class="fas fa-phone"></i> ${apt.patientPhone}</small>
                                        </div>
                                        <div class="col-md-3">
                                            <i class="fas fa-clock"></i> ${formatTime(apt.startTime)} - ${formatTime(apt.endTime)}
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-warning">${apt.status}</span>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button onclick="completeAppointment('${apt.id}', '${apt.patientName}')" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i> Complete
                                            </button>
                                        </div>
                                    </div>
                                    ${apt.notes ? `<div class="row mt-2"><div class="col-12"><small class="text-muted"><i class="fas fa-sticky-note"></i> <strong>Notes:</strong> ${apt.notes}</small></div></div>` : ''}
                                </div>
                            `;
                        });
                        $('#queueList').html(html);
                    }
                },
                error: function(xhr) {
                    console.error('Error loading queue:', xhr);
                    showAlert('Failed to load queue', 'error');
                }
            });
        }

        // Format TimeSpan to readable time
        function formatTime(timeSpan) {
            if (!timeSpan) return '';
            // TimeSpan comes as "HH:mm:ss" format from server
            const parts = timeSpan.toString().split(':');
            if (parts.length >= 2) {
                return parts[0] + ':' + parts[1];
            }
            return timeSpan;
        }

        // Refresh Grid
        function refreshGrid() {
            var selectedDate = $('#appointmentDate').val();
            $.ajax({
                url: '@Url.Action("GetNotificationsGrid")',
                type: 'GET',
                data: { selectedDate: selectedDate },
                success: function(result) {
                    $('#gridContainer').html(result);
                    // Reinitialize MVC Grid
                    document.querySelectorAll(".mvc-grid").forEach(el => new MvcGrid(el));
                },
                error: function(xhr) {
                    console.error('Error refreshing grid:', xhr);
                    showAlert('Failed to refresh grid', 'error');
                }
            });
        }

        // Show Alert
        function showAlert(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            var alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${iconClass}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('#alertContainer').html(alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('#alertContainer .alert').fadeOut(function() {
                    $(this).remove();
                });
            }, 5000);
        }

        // Handle form submissions in modal
        $(document).on('submit', '#actionModalBody form', function(e) {
            e.preventDefault();
            var form = $(this);
            var formData = new FormData(this);
            
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        showAlert(response.message, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                        refreshGrid();
                    } else {
                        $('#actionModalBody').html(response);
                    }
                },
                error: function(xhr) {
                    console.error('Error submitting form:', xhr);
                    showAlert('Failed to submit form', 'error');
                }
            });
        });

        // Auto-refresh every 30 seconds
        setInterval(function() {
            refreshGrid();
            if ($('#queuePanel').is(':visible')) {
                loadQueue();
            }
        }, 30000);
    </script>
    @Html.AntiForgeryToken()
}
