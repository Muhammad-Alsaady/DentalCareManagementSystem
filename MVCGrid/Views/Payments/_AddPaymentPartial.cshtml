@model DentalCareManagmentSystem.Application.DTOs.PaymentTransactionDto

<div class="payment-form-container">
    <!-- Payment Summary Section -->
    <div id="paymentSummaryContainer" class="mb-4">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Loading payment summary...
        </div>
    </div>

    <!-- Payment Entry Form -->
    <form asp-action="AddPayment" asp-controller="Payments" method="post" class="needs-validation" id="paymentForm">
        @Html.AntiForgeryToken()
        
        <input type="hidden" name="patientId" value="@Model.PatientId" />
        <input type="hidden" name="appointmentId" value="@Model.AppointmentId" />

        <div class="row">
            <!-- Amount -->
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="amount" class="form-label required">
                        <i class="fas fa-dollar-sign"></i> Amount Paid
                    </label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">LE</span>
                        <input type="number" 
                               class="form-control form-control-lg" 
                               id="amount" 
                               name="amount" 
                               value="@Model.Amount" 
                               step="0.01" 
                               min="0" 
                               required 
                               autofocus 
                               placeholder="0.00">
                    </div>
                    <span asp-validation-for="Amount" class="text-danger"></span>
                </div>
            </div>

            <!-- Payment Date -->
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="paymentDate" class="form-label">
                        <i class="fas fa-calendar"></i> Payment Date
                    </label>
                    <input type="date" 
                           class="form-control form-control-lg" 
                           id="paymentDate" 
                           name="paymentDate" 
                           value="@DateTime.Now.ToString("yyyy-MM-dd")" 
                           max="@DateTime.Now.ToString("yyyy-MM-dd")" 
                           required>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="form-group mb-4">
            <label for="notes" class="form-label">
                <i class="fas fa-sticky-note"></i> Notes (Optional)
            </label>
            <textarea class="form-control" 
                      id="notes" 
                      name="notes" 
                      rows="3" 
                      placeholder="Add any notes about this payment...">@Model.Notes</textarea>
        </div>

        <!-- Submit Buttons -->
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-save"></i> Save Payment
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="ModalLoader.close()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>

<style>
    .payment-form-container {
        padding: 10px 0;
    }

    .required::after {
        content: " *";
        color: #dc3545;
    }

    .input-group-lg .form-control {
        font-size: 1.5rem;
        font-weight: 600;
        text-align: right;
    }

    .input-group-lg .input-group-text {
        font-size: 1.2rem;
        font-weight: 600;
        background: #e5e7eb;
    }

    #paymentForm .form-control:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    #paymentForm .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        font-size: 1.1rem;
        padding: 14px;
    }

    #paymentForm .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
    }
</style>

<script>
    $(document).ready(function() {
        // Load payment summary immediately
        var patientId = '@Model.PatientId';
        if (patientId && patientId !== '00000000-0000-0000-0000-000000000000') {
            loadPaymentSummary(patientId);
        }

        // Handle form submission
        $('#paymentForm').off('submit').on('submit', function(e) {
            e.preventDefault();
            submitPaymentForm(this);
        });

        // Auto-calculate remaining when amount changes
        $('#amount').on('input', function() {
            calculateRemaining();
        });
    });

    function loadPaymentSummary(patientId) {
        $.ajax({
            url: '@Url.Action("GetPatientPaymentSummary", "Payments")',
            data: { patientId: patientId },
            success: function(html) {
                $('#paymentSummaryContainer').html(html);
            },
            error: function() {
                $('#paymentSummaryContainer').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Unable to load payment summary
                    </div>
                `);
            }
        });
    }

    function submitPaymentForm(form) {
        var formData = new FormData(form);
        
        $.ajax({
            url: $(form).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    ModalLoader.close();
                    UIHelpers.showAlert(response.message, 'success');
                    
                    // Trigger grid refresh
                    $(document).trigger('modalSuccess', [response]);
                } else {
                    // Show validation errors (response is HTML)
                    $('#globalModalBody').html(response);
                }
            },
            error: function(xhr) {
                var errorMsg = 'Error adding payment. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                UIHelpers.showAlert(errorMsg, 'danger');
            }
        });
    }

    function calculateRemaining() {
        var amount = parseFloat($('#amount').val()) || 0;
        var totalCost = parseFloat($('#totalCostValue').text()) || 0;
        var totalPaid = parseFloat($('#totalPaidValue').text()) || 0;
        var newRemaining = totalCost - (totalPaid + amount);
        
        $('#remainingAfterPayment').text(newRemaining.toFixed(2));
        
        if (newRemaining <= 0) {
            $('#remainingAfterPayment').removeClass('text-danger').addClass('text-success');
        } else {
            $('#remainingAfterPayment').removeClass('text-success').addClass('text-danger');
        }
    }
</script>
