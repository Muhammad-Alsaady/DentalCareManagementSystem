@model IEnumerable<DentalCareManagmentSystem.Application.DTOs.PatientDto>
@{
    ViewData["Title"] = "Patients";
}

@* Anti-forgery token for delete operations *@
@Html.AntiForgeryToken()

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-users me-2"></i>Patients</h2>
        <button class="btn btn-success" onclick="showCreate()">
            <i class="fas fa-plus me-1"></i> Add New Patient
        </button>
    </div>

    <!-- Grid -->
    <div class="card shadow-sm">
        <div class="card-body" id="gridContainer">
            @await Html.PartialAsync("_PatientsGrid", Model)
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Reload the grid after a modal form is submitted successfully
        $(document).on('modalSuccess', function () {
            refreshGrid();
        });

        // Show Create Form using Global Modal
        function showCreate() {
            ModalLoader.load('@Url.Action("Create")', 'Add New Patient');
        }

        // Show Edit Form using Global Modal
        function showEdit(id) {
            ModalLoader.load('@Url.Action("Edit")/' + id, 'Edit Patient');
        }

        // Show Details using Global Modal
        function showDetails(id) {
            ModalLoader.load('@Url.Action("Details")/' + id, 'Patient Details');
        }

        // Create Appointment for Patient using Global Modal
        function createAppointment(patientId, patientName) {
            ModalLoader.load(
                '@Url.Action("Create", "Appointments")?patientId=' + patientId,
                'New Appointment for ' + patientName
            );
        }

        // Delete Patient - Using SweetAlert2 confirmation
        function deletePatient(id, name) {
            Swal.fire({
                title: 'Are you sure?',
                html: `You are about to delete <strong>${name}</strong>.<br/>You won't be able to revert this!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    confirmDeletePatient(id);
                }
            });
        }

        // Confirm Delete Patient
        function confirmDeletePatient(id) {
            $.ajax({
                url: '@Url.Action("DeleteConfirmed")/' + id,
                type: 'POST',
                data: {
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: response.message || 'Patient has been deleted successfully.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        refreshGrid();
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'Delete failed! Please try again.',
                            icon: 'error'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Delete failed! Please try again.',
                        icon: 'error'
                    });
                }
            });
        }

        // Refresh Grid
        function refreshGrid() {
            var gridElement = document.getElementById('patients-grid');
            if (gridElement && typeof MvcGrid !== 'undefined') {
                new MvcGrid(gridElement).reload();
            } else {
                console.error('MvcGrid not found or not loaded');
                location.reload(); // Fallback: reload entire page
            }
        }

        // MVC Grid events
        document.addEventListener('mvc-grid-init', (e) => {
            const grid = e.detail.grid;
            if (grid.element.id === 'patients-grid') {
                grid.element.addEventListener('reloadend', () => {
                    console.log('Patients grid reloaded.');
                });
            }
        });
    </script>
}
