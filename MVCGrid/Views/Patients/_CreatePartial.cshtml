@model DentalCareManagmentSystem.Application.DTOs.PatientDto

<form asp-action="Create" method="post" id="patientCreateForm">
    @Html.AntiForgeryToken()
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="FullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                <input asp-for="FullName" class="form-control" placeholder="Enter full name" required />
                <span asp-validation-for="FullName" class="text-danger"></span>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="Phone" class="form-label">Phone <span class="text-danger">*</span></label>
                <input asp-for="Phone" type="tel" class="form-control" placeholder="Enter phone number" required />
                <span asp-validation-for="Phone" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="Age" class="form-label">Age <span class="text-danger">*</span></label>
                <input asp-for="Age" type="number" class="form-control" placeholder="Enter age" min="1" max="150" required />
                <span asp-validation-for="Age" class="text-danger"></span>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="Gender" class="form-label">Gender <span class="text-danger">*</span></label>
                <select asp-for="Gender" class="form-select" required>
                    <option value="">-- Select Gender --</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <span asp-validation-for="Gender" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Create Patient & Add Appointment
        </button>
    </div>
</form>

<script>
    $(document).ready(function() {
        // Handle form submission
        $('#patientCreateForm').on('submit', function(e) {
            e.preventDefault();
            
            var $form = $(this);
            var $submitBtn = $form.find('button[type=submit]');
            var originalText = $submitBtn.html();
            
            // Disable submit button
            $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creating...');
            
            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(response) {
                    if (response.success) {
                        // Show success message
                        UIHelpers.showAlert(response.message, 'success');
                        
                        // Close the modal
                        ModalLoader.close();
                        
                        // ALWAYS open appointment modal after patient is created
                        if (response.patientId) {
                            // Wait for modal to close, then open appointment modal
                            setTimeout(function() {
                                ModalLoader.load(
                                    '@Url.Action("Create", "Appointments")?patientId=' + response.patientId,
                                    'New Appointment for ' + (response.patientName || 'Patient')
                                );
                            }, 500);
                        }
                        
                        // Trigger modal success event to refresh grid
                        $(document).trigger('modalSuccess', [response]);
                    } else {
                        // Show validation errors - reload form with errors
                        $('#globalModalBody').html(response);
                        $submitBtn.prop('disabled', false).html(originalText);
                    }
                },
                error: function(xhr) {
                    $submitBtn.prop('disabled', false).html(originalText);
                    UIHelpers.showAlert('Error creating patient. Please try again.', 'danger');
                }
            });
        });
    });
</script>
