@model List<DentalCareManagmentSystem.Application.DTOs.AppointmentDto>
@{
    ViewData["Title"] = "Appointments";
    var selectedDate = ViewBag.SelectedDate as DateTime? ?? DateTime.Today;
    var selectedStatus = ViewBag.SelectedStatus as string ?? "";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-calendar-alt"></i> Appointments</h2>
                <div>
                    <button class="btn btn-success" onclick="showCreate()">
                        <i class="fas fa-plus"></i> New Appointment
                    </button>
                    <button class="btn btn-outline-primary" onclick="refreshAppointments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <hr />
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" id="filterDate" class="form-control" 
                                   value="@selectedDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select id="filterStatus" class="form-select">
                                <option value="">All</option>
                                <option value="Scheduled" selected="@(selectedStatus == "Scheduled")">Scheduled</option>
                                <option value="Notified" selected="@(selectedStatus == "Notified")">Notified</option>
                                <option value="Completed" selected="@(selectedStatus == "Completed")">Completed</option>
                                <option value="Cancelled" selected="@(selectedStatus == "Cancelled")">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body" id="gridContainer">
                    @await Html.PartialAsync("_AppointmentsGrid", Model)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for CRUD operations -->
<div class="modal fade" id="crudModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crudModalLabel">Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="crudModalBody">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let crudModal;

        $(document).ready(function() {
            // Initialize modal
            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));

            // Enable auto-refresh every 15 seconds
            UIHelpers.enableAutoRefresh(
                'AppointmentsGrid',
                '#gridContainer',
                '@Url.Action("GetAppointmentsGrid")',
                {
                    date: $('#filterDate').val(),
                    status: $('#filterStatus').val()
                }
            );

            // Setup AJAX form handler for appointment forms
            UIHelpers.ajaxFormHandler('#appointmentForm', function(response) {
                refreshAppointments();
            });
        });

        // Show Create Form
        function showCreate() {
            UIHelpers.loadModal('@Url.Action("Create")', 'Create Appointment');
        }

        // Show Edit Form
        function showEdit(id) {
            UIHelpers.loadModal('@Url.Action("Edit")/' + id, 'Edit Appointment');
        }

        // Show Delete Confirmation
        function showDelete(id) {
            UIHelpers.loadModal('@Url.Action("Delete")/' + id, 'Delete Appointment');
        }

        // Show Details
        function showDetails(id) {
            UIHelpers.loadModal('@Url.Action("Details")/' + id, 'Appointment Details');
        }

        // Update Status
        function updateStatus(id, status) {
            UIHelpers.confirm(`Change status to ${status}?`, function() {
                UIHelpers.ajaxAction(
                    '@Url.Action("UpdateStatus")',
                    { id: id, status: status },
                    function(response) {
                        refreshAppointments();
                    }
                );
            });
        }

        // Apply Filters
        function applyFilters() {
            const date = $('#filterDate').val();
            const status = $('#filterStatus').val();
            
            // Update grid with filters
            UIHelpers.reloadGridPartial(
                '#gridContainer',
                '@Url.Action("GetAppointmentsGrid")',
                { date: date, status: status }
            );

            // Update auto-refresh with new filters
            UIHelpers.enableAutoRefresh(
                'AppointmentsGrid',
                '#gridContainer',
                '@Url.Action("GetAppointmentsGrid")',
                { date: date, status: status }
            );
        }

        // Clear Filters
        function clearFilters() {
            $('#filterDate').val('@DateTime.Today.ToString("yyyy-MM-dd")');
            $('#filterStatus').val('');
            applyFilters();
        }

        // Refresh Appointments
        function refreshAppointments() {
            applyFilters();
        }

        // Cleanup on page unload
        $(window).on('beforeunload', function() {
            UIHelpers.disableAutoRefresh('AppointmentsGrid');
        });
    </script>
}
