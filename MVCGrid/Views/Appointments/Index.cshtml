@model IEnumerable<DentalCareManagmentSystem.Application.DTOs.AppointmentDto>
@{
    ViewData["Title"] = "Appointments";
}

@* Anti-forgery token for delete operations *@
@Html.AntiForgeryToken()

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-calendar-alt me-2"></i>Appointments</h2>
        <button class="btn btn-success" onclick="showCreate()">
            <i class="fas fa-plus me-1"></i> New Appointment
        </button>
    </div>

    <!-- Grid -->
    <div class="card shadow-sm">
        <div class="card-body" id="gridContainer">
            @await Html.PartialAsync("_AppointmentsGrid", Model)
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Reload the grid after a modal form is submitted successfully
        $(document).on('modalSuccess', function () {
            refreshGrid();
        });

        // Show Create Form using Global Modal
        function showCreate() {
            ModalLoader.load('@Url.Action("Create")', 'Create Appointment');
        }

        // Show Edit Form using Global Modal
        function showEdit(id) {
            ModalLoader.load('@Url.Action("Edit")/' + id, 'Edit Appointment');
        }
        
        // Show Details using Global Modal
        function showDetails(id) {
            ModalLoader.load('@Url.Action("Details")/' + id, 'Appointment Details');
        }

        // Delete Appointment - Using SweetAlert2 confirmation
        function deleteAppointment(id, patientName) {
            Swal.fire({
                title: 'Are you sure?',
                html: `You are about to delete the appointment for <strong>${patientName}</strong>.<br/>You won't be able to revert this!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    confirmDeleteAppointment(id);
                }
            });
        }

        // Confirm Delete Appointment
        function confirmDeleteAppointment(id) {
            $.ajax({
                url: '@Url.Action("DeleteConfirmed")/' + id,
                type: 'POST',
                data: {
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: response.message || 'Appointment has been deleted successfully.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        refreshGrid();
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'Delete failed! Please try again.',
                            icon: 'error'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Delete failed! Please try again.',
                        icon: 'error'
                    });
                }
            });
        }

        // Update Status
        function updateStatus(id, status) {
            UIHelpers.showConfirmation('Update Status?', `Change status to <strong>${status}</strong>?`, function () {
                confirmUpdateStatus(id, status);
            }, 'btn-primary');
        }

        function confirmUpdateStatus(id, status) {
            UIHelpers.ajaxAction(
                '@Url.Action("UpdateStatus")',
                { id: id, status: status },
                function(response) {
                    // On success, the grid will be refreshed by the global handler
                    refreshGrid();
                }
            );
        }

        // Refresh Appointments Grid
        function refreshGrid() {
            var gridElement = document.getElementById('AppointmentsGrid');
            if (gridElement && typeof MvcGrid !== 'undefined') {
                new MvcGrid(gridElement).reload();
            } else {
                console.error('MvcGrid not found or not loaded');
                location.reload(); // Fallback: reload entire page
            }
        }

        // MVC Grid events
        document.addEventListener('mvc-grid-init', (e) => {
            const grid = e.detail.grid;
            grid.element.addEventListener('reloadend', () => {
                // You can add any logic here that needs to run after the grid reloads
                console.log('Appointments grid reloaded.');
            });
        });
    </script>
}
