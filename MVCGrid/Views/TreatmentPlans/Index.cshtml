@model List<DentalCareManagmentSystem.Application.DTOs.TreatmentPlanDto>
@using NonFactors.Mvc.Grid
@using System.Text
@{
    ViewData["Title"] = "Treatment Plans";
}

@* Anti-forgery token for delete operations *@
@Html.AntiForgeryToken()

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-medkit me-2"></i>Treatment Plans</h2>
    </div>

    <!-- Grid -->
    <div class="card shadow-sm">
        <div class="card-body" id="gridContainer">
            @await Html.PartialAsync("_TreatmentPlansGrid", Model)
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Delete Plan - Using SweetAlert2 confirmation
        function deletePlan(id) {
            Swal.fire({
                title: 'Are you sure?',
                html: 'You are about to delete this treatment plan.<br/>You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    confirmDeletePlan(id);
                }
            });
        }

        // Confirm Delete Plan
        function confirmDeletePlan(id) {
            $.ajax({
                url: '@Url.Action("DeletePlanConfirmed")',
                type: 'POST',
                data: {
                    id: id,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: response.message || 'Treatment plan has been deleted successfully.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        refreshGrid();
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message || 'Delete failed! Please try again.',
                            icon: 'error'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Error!',
                        text: 'Delete failed! Please try again.',
                        icon: 'error'
                    });
                }
            });
        }

        // Refresh Grid
        function refreshGrid() {
            const gridElement = document.getElementById('TreatmentPlansGrid');
            if (gridElement && typeof MvcGrid !== 'undefined') {
                new MvcGrid(gridElement).reload();
            } else {
                console.error('MvcGrid not found or not loaded');
                location.reload(); // Fallback: reload entire page
            }
        }
    </script>
}
